services:


  postgres:
    image: postgres:16-alpine
    container_name: gitea-postgres
    restart: unless-stopped
    command: postgres -c 'max_connections=200'
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - gitea
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: gitea-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - gitea
    volumes:
      - ./data/redis:/data

  minio:
    image: minio/minio:latest
    container_name: gitea-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - gitea
    volumes:
      - ./data/minio:/data

  minio-init:
    image: minio/mc:latest
    container_name: gitea-minio-init
    depends_on:
      minio:
        condition: service_healthy
    restart: "no"
    networks:
      - gitea
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        until mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; do
          echo 'Waiting for MinIO...'; sleep 2;
        done
        mc mb --ignore-existing local/${MINIO_BUCKET}
        echo 'MinIO bucket ready.'

  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      # Basic app
      USER_UID: "1000"
      USER_GID: "1000"

      # Web/SSH - Now behind Caddy reverse proxy with HTTPS
      GITEA__server__DOMAIN: ${GITEA_DOMAIN}
      GITEA__server__ROOT_URL: https://${GITEA_DOMAIN}/
      GITEA__server__HTTP_PORT: 3000
      GITEA__server__SSH_DOMAIN: ${GITEA_DOMAIN}
      GITEA__server__SSH_PORT: 2222
      GITEA__server__SSH_LISTEN_PORT: 22

      # Database (Postgres)
      GITEA__database__DB_TYPE: postgres
      GITEA__database__HOST: postgres:5432
      GITEA__database__NAME: ${POSTGRES_DB}
      GITEA__database__USER: ${POSTGRES_USER}
      GITEA__database__PASSWD: ${POSTGRES_PASSWORD}
      GITEA__database__SSL_MODE: disable


      # Container Registry (packages/Docker images) -> MinIO
      GITEA__packages__STORAGE_TYPE: minio
      GITEA__packages__MINIO_ENDPOINT: minio:9000
      GITEA__packages__MINIO_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      GITEA__packages__MINIO_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      GITEA__packages__MINIO_BUCKET: ${MINIO_BUCKET}
      GITEA__packages__MINIO_LOCATION: us-east-1
      GITEA__packages__MINIO_USE_SSL: "false"

      # Redis Cache - Improves performance significantly
      GITEA__cache__ENABLED: "true"
      GITEA__cache__ADAPTER: redis
      GITEA__cache__HOST: redis://redis:6379/0?pool_size=100&idle_timeout=180s

      # Session storage via Redis
      GITEA__session__PROVIDER: redis
      GITEA__session__PROVIDER_CONFIG: redis://redis:6379/1?pool_size=100&idle_timeout=180s

      # Queue system via Redis
      GITEA__queue__TYPE: redis
      GITEA__queue__CONN_STR: redis://redis:6379/2?pool_size=100&idle_timeout=180s

      # First-run behavior: keeps installation UI, but you can lock after setup
      # GITEA__security__INSTALL_LOCK: "true"

    ports:
      - "2222:22"
      - "3000:3000"
    networks:
      - gitea
    volumes:
      - ./data/gitea:/data

  runner:
    image: gitea/act_runner:latest
    container_name: gitea-runner
    restart: unless-stopped
    depends_on:
      - gitea
    environment:
      GITEA_INSTANCE_URL: http://gitea:3000
      GITEA_RUNNER_REGISTRATION_TOKEN: ${RUNNER_TOKEN}
      GITEA_RUNNER_NAME: local-runner
      GITEA_RUNNER_LABELS: ubuntu-latest:docker://node:20-bullseye,ubuntu-22.04:docker://node:20-bullseye,ubuntu-20.04:docker://node:20-bullseye
    networks:
      - gitea
    # Bind-mount for runner data + docker socket for container jobs
    volumes:
      - ./data/runner:/data
      - /var/run/docker.sock:/var/run/docker.sock

  nexus:
    image: sonatype/nexus3
    container_name: nexus
    restart: unless-stopped
    ports:
      - "8081:8081"
    volumes:
      - ./data/nexus:/nexus-data
    networks:
      - gitea
    environment:
      - INSTALL4J_ADD_VM_PARAMS=-Xms1200m -Xmx1200m -XX:MaxDirectMemorySize=2g -Djava.util.prefs.userRoot=/nexus-data/javaprefs

  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - ./data/jenkins:/var/jenkins_home
    networks:
      - gitea
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false

  vault:
    image: hashicorp/vault:latest
    container_name: vault
    restart: unless-stopped
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    volumes:
      - ./data/vault:/vault/file
      - ./config/vault.hcl:/vault/config/vault.hcl
    command: vault server -config=/vault/config/vault.hcl
    networks:
      - gitea

networks:
  gitea:
    name: gitea
